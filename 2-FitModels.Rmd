### Purspose

This code covers model fitting for the parks VIC hmsc project. The subsequent codes are laid out in the same fashion as suggested in the HMSC book.

### 0) Setup - identify working directory and set seed

```{r setup} 

knitr::opts_knit$set(root.dir = "Z:/GIS-Res/Projects/ParksVic_Hmsc/Modelling/")
set.seed(1995)

```

### 1) Package Import

```{r}
library(Hmsc)
library(corrplot)
library(dplyr)
```

### 3) Directories

```{r}
localDir = getwd()
data.directory = file.path(localDir, "ResponseCSVs")
model.directory = file.path(localDir, "UnfittedModels")

```

### 4) Check intercorrelation

First off, we need to see how many of our environmental predictors are intercorrelated. We have loads of measures of similar variables (e.g. 5 temp measures, 5 wave measures) so there is likely to be a bit to cut here. Like other models, HMSC doesnt really want you to add loads of predictors that each represent the same ecological phenomena.

```{r}
#Import fish and invert data
fishData = read.csv(file.path(data.directory, "fishDataFinal.csv"), stringsAsFactors = TRUE)
invertData = read.csv(file.path(data.directory, "invertDataFinal.csv"), stringsAsFactors = TRUE)


#Check intercor of all environmental predictors. Looking for Pearsons >0.7.
cor1 = fishData[,12:31] %>% cor(method = "pearson")
corrplot(cor1, method = "number", type = "lower", diag = FALSE)

#adjSD doesnt play well with vrm or qslope. The latter two dont play together either. All wave measures are >0.7. Temp doesn't look much better.
#Try again with just seasonal measure and SD for wave and temp. And drop Qslope and vrm. Mean for temp as longer times are needed to impact physiological stress but waves get 95th as a single big wave might do damage.
cor1 = fishData[,c(12:17, 19:20, 24, 26, 30, 31)] %>% cor(method = "pearson")
corrplot(cor1, method = "number", type = "lower", diag = FALSE)

#Terrains are better but the waves still trip us up. Repeat for just seasonal mean for temp and seasonal 95th for waves.
cor1 = fishData[,c(12:17, 19:20, 26, 30)] %>% cor(method = "pearson")
corrplot(cor1, method = "number", type = "lower", diag = FALSE)

#Lets run with that.
fishData = fishData[,c(1:11, 12:17, 19:20, 24, 30, 32:278)]


#Repeat for inverts.....
#Check intercor of all environmental predictors. Looking for Pearsons <0.7.
cor1 = invertData[,12:31] %>% cor(method = "pearson")
corrplot(cor1, method = "number", type = "lower", diag = FALSE)

#adjSD doesnt play well with vrm or qslope. The latter two dont play together either. All wave measures are >0.7. Temp doesn't look much better.
#Try again with just seasonal measure and SD for wave and temp. And drop Qslope and vrm. Mean for temp as longer times are needed to impact physiological stress but waves get 95th as a single big wave might do damage.
cor1 = invertData[,c(12:17, 19:20, 24, 26, 30, 31)] %>% cor(method = "pearson")
corrplot(cor1, method = "number", type = "lower", diag = FALSE)

#Terrains are better but the waves still trip us up. Repeat for just seasonal mean for temp and seasonal 95th for waves.
cor1 = invertData[,c(12:17, 19:20, 24, 30)] %>% cor(method = "pearson")
corrplot(cor1, method = "number", type = "lower", diag = FALSE)

#Lets run with that. Unsurprisingly identical process as I think the RSL survey data take place at the same locales. Marginally different col numbers mind. Different N species found.
invertData = invertData[,c(1:11, 12:17, 19:20, 24, 30, 32:283)]

```

### 5) Begin model fitting.

Check data structure and amend as needed.

```{r}
str(fishData)
fishData$year = as.factor(fishData$year)

str(invertData)
invertData$year = as.factor(invertData$year)

```


Extract X matrix - environmental variables.

```{r}
fishX = fishData[,12:21]

invertX = invertData[,12:21]

```

Extract Y matrix - occurences and abundances.

```{r}
fishY = (fishData[,22:247])
invertY = (invertData[,22:273])

#Check for absent or ubiquitous species. Fact it returns a value tells us we have no NAs in our rows too
range(colMeans(fishY>0))
min(colSums(fishY>0)) #Some fish weren't found in any samples

range(colMeans(invertY>0))
min(colSums(invertY>0)) #Some inverts weren't found in any samples

#Check the number of rare taxa (those present in less than 5% of samples)
rareFish <- which(colSums(fishY>0)<64) #64 is ~5% of samples
length(rareFish) #117 rare fish

rareInvert <- which(colSums(invertY>0)<64) #64is ~5% of samples
length(rareInvert) #206 rare inverts

#Check the number of overabundant taxa (those present in greater than 95% of samples)
ovabunFish <- which(colSums(fishY>0)>1203) #1203 is ~95% of samples
length(ovabunFish) #1 overly abundant fish

ovabunInvert <- which(colSums(invertY>0)>1217) #1217 is ~95% of samples
length(ovabunInvert) #0 overly abundant inverts

#Drop rare or overabundant species
fishY <- fishY[ , -c(rareFish, ovabunFish)]
invertY <- invertY[ , -c(rareInvert, ovabunInvert)]

#Dropping the rare species leaves 48 fish and 46 inverts.

#Assess abundance histogram, prevalence, and log abundance conditional on presence
hist(colMeans(fishY), nclass = 35, main = "Mean Abun per sample unit") #Most fish are in super low densities (<6 abundance per sample) per sample unit but 8-10 (25% of all fish left in the data) have higher abundance spanning up 35 individuals per sample on average. Huge 0 spike here.
hist(colMeans(fishY>0), main = "Prevalence") #Where a given fish species is present most have <0.3 prevalence. 9 or so appear to have >0.4 prevalence.
hist(log(fishY[fishY>0]), main = "log abundance conditional on presence") #Across all fish, even when logged, the abundance is still skewed towards small values. Reduced 0 spike compared to untransformed data mind.
hist(rowSums(fishY>0), main = "Richness") #Most samples have moderate species richness ~12 fish species per sample. Slight skew to lower richnesses but pretty normal.

hist(colMeans(invertY), nclass = 20, main = "Mean Abun per sample unit") #Most invert species are hardly present on average, some have increased abundance to ~30 on average across sample units then some a handful (1-2) are comparatively super common. Up to 80-100 individuals per sample unit. 
hist(colMeans(invertY>0), nclass = 10, main = "Prevalence") #Most inverts have <0.2 prevalence. Then a few more have 0.2-0.3. Beyond which it really drops off in frequency to the higher prevalence. Generally very few species are strongly prevalent.
hist(log(invertY[invertY>0]), main = "log abundance conditional on presence") #As with fish there is still strong negative skew. Better than untransformed though.
hist(rowSums(invertY>0), main = "Richness") #Most samples have moderate species richness ~12 inverts per sample. Slight skew to lower richnesses but pretty normal.


```

From the above we can see that both our fish and invert data have strongly positively skewed abundances (lean towards loads of 0s and few high abundances). Looks like we may need a hurdle model so that HMSC can model the presence as one component, then where the species is present we can build another model to predict the abundances.

### BEGIN HERE!!!!!!!!!!!!!!!!!!!!!!

Extract S matrix - Study design aspects.

```{r}
fishS = fishData[,c(1,3,6,7,8,9)] #Grab site name, sampling, year, imcra bioregion, MPA protection status (protected or not?), the MPA name the points are associated with, and the broader geographic region as study design components

invertS = invertData[, c(1,3,6,7,8,9)] #As above

#These are all factor variables
```

Finally we can make some random effect variables.

```{r}
fishXY = as.matrix(cbind(fishData$longitude, fishData$latitude))
rownames(xy)= S$SampleID
colnames(xy)=c("x-coordinate","y-coordinate")

rL.nngp <- HmscRandomLevel(sData = xy, longlat = FALSE, sMethod = 'NNGP',nNeighbours = 10)
rL.nngp <- setPriors(rL.nngp,nfMin=1,nfMax=1)

#rL.strata <- HmscRandomLevel(units = levels(studyDesign$strata))

#Add year as random effect. Helps account for temporal autocorrelation.
rL.fish.dyear <- HmscRandomLevel(units = levels(fishS$year))
rL.invert.dyear <- HmscRandomLevel(units = levels(invertS$year))




```





